# Backend Security Standards (2026 Edition)

## 1. Environment Variables & Secrets
*   **Rule**: NEVER commit `.env` files.
*   **Rule**: Secrets (API keys, DB passwords) must reside in `.env.local` only.
*   **Client Exposure**: Only variables prefixed with `NEXT_PUBLIC_` are visible to the browser.
    *   ✅ `NEXT_PUBLIC_ANALYTICS_ID`
    *   ❌ `DB_PASSWORD` (Must not have prefix)

## 2. Server Actions & API Routes
Server Actions are **public HTTP endpoints**. They are not private functions.

*   **Input Validation**: ALL inputs must be validated with Zod/Yup.
    ```typescript
    // ❌ BAD
    export async function updateProfile(data) {
      await db.update(data); // SQL Injection risk
    }

    // ✅ GOOD
    const schema = z.object({ name: z.string().min(2) });
    export async function updateProfile(rawData) {
      const { data } = schema.parse(rawData); // Throws if invalid
      await db.update(data);
    }
    ```
*   **Authentication**: Always check `getSession()` inside the action. Middleware is not enough.
    ```typescript
    const session = await getSession();
    if (!session) throw new Error("Unauthorized");
    ```

## 3. Database Safety
*   **Prisma**: Use strict types generated by `prisma generate`.
*   **docker-compose**: Limit port exposure.
    *   In production, do NOT map `5432:5432`. Use an internal network.
    *   Only expose `5432` for local development.

## 4. GitHub Safety Rules
Before pushing code:
1.  Run `git status` to check for unexpected files.
2.  Ensure `.gitignore` includes:
    *   `.env*`
    *   `postgres_data/`
    *   `node_modules/`
    *   `.gemini/` (AI artifacts)
3.  Scan for hardcoded secrets (use tools like `trufflehog` or ask Jules to review).
